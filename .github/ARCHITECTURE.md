# ๐๏ธ CI/CD Architecture

## ๐ Visรฃo Geral do Pipeline

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                         DEVELOPMENT                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                โ
                    โโโโโโโโโโโโโโโโโโโโโโโโ
                    โ   Git Push / PR      โ
                    โโโโโโโโโโโโโโโโโโโโโโโโ
                                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    CONTINUOUS INTEGRATION                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                  โ
โ  โโโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ   โ
โ  โ  Code Quality   โ  โ  Security Scan   โ  โ  Tests PHP   โ   โ
โ  โ  (Pint/PHPStan) โ  โ  (Composer Audit)โ  โ  8.2/8.3/8.4 โ   โ
โ  โโโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ   โ
โ           โ                    โ                     โ          โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ              Build Docker Image                         โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                โ
                    โโโโโโโโโโโโโโโโโโโโโโโโ
                    โ   Merge to main      โ
                    โโโโโโโโโโโโโโโโโโโโโโโโ
                                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                  ARTIFACT DEPLOYMENT (IMAGENS)                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ  1. Build de Imagem Docker                             โ   โ
โ  โ  2. Tag e Metadados                                    โ   โ
โ  โ  3. (Opcional) Push para ghcr.io                       โ   โ
โ  โ  4. Scan de Vulnerabilidades (Trivy)                   โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ Fluxo de Workflows

### 1. CI - Tests and Code Quality

```
Push/PR
  โ
  โโโ Setup PHP (8.2, 8.3, 8.4)
  โ     โ
  โ     โโโ Install Dependencies
  โ     โ     โ
  โ     โ     โโโ Run Tests (Parallel + Coverage)
  โ     โ     โ     โโโ โ Pass โ Continue
  โ     โ     โ     โโโ โ Fail โ Block PR
  โ     โ     โ
  โ     โ     โโโ Code Style (Pint)
  โ     โ     โ     โโโ โ Pass โ Continue
  โ     โ     โ     โโโ โ Fail โ Block PR
  โ     โ     โ
  โ     โ     โโโ Static Analysis (PHPStan)
  โ     โ     โ     โโโ โ Pass โ Continue
  โ     โ     โ     โโโ โ๏ธ  Warning โ Log
  โ     โ     โ
  โ     โ     โโโ Security Audit
  โ     โ           โโโ โ No Issues โ Continue
  โ     โ           โโโ โ๏ธ  Vulnerabilities โ Log
  โ     โ
  โ     โโโ Upload Coverage to Codecov
  โ
  โโโ Build Docker Image (if main branch)
        โโโ โ Success โ Cache Image
        โโโ โ Fail โ Notify
```

### 2. Artifact Deployment (Imagens Docker)

```
Push to main / Create Tag (Opcional)
  โ
  โโโ Construir e Publicar imagem em ghcr.io
  โ     โโโ Tags automรกticas (semver, sha, latest)
  โ     โโโ Multi-arch (amd64, arm64)
  โ     โโโ Scan (Trivy) + Upload para Security Tab
```

### 3. Docker Build and Push

```
Push to main / Tag
  โ
  โโโ Extract Metadata (tags, labels)
  โ     โ
  โ     โโโ Build Multi-Platform Image
  โ     โ     โโโ linux/amd64
  โ     โ     โโโ linux/arm64
  โ     โ
  โ     โโโ Push to GHCR (ghcr.io)
  โ     โ     โโโ latest
  โ     โ     โโโ v1.2.3
  โ     โ     โโโ sha-abc123
  โ     โ
  โ     โโโ Scan with Trivy
  โ     โ     โโโ โ No Vulnerabilities
  โ     โ     โโโ โ๏ธ  Issues โ Upload to Security Tab
  โ     โ
  โ     โโโ Test Stack
  โ           โโโ Compose Up
  โ           โโโ Run PHP Version Check
  โ           โโโ Compose Down
```

### 4. Security Audit

```
Schedule (Weekly) / Manual
  โ
  โโโ Composer Audit
  โ     โโโ Check Dependencies
  โ     โโโ โ No Issues
  โ     โโโ โ๏ธ  Vulnerabilities โ Create Issue
  โ
  โโโ CodeQL Analysis
  โ     โโโ Scan PHP Code
  โ     โโโ Scan JavaScript Code
  โ     โโโ โ No Issues
  โ     โโโ โ๏ธ  Issues โ Security Tab
  โ
  โโโ Dependency Review (PRs only)
        โโโ Compare Dependencies
        โโโ โ Safe Changes
        โโโ โ Risky Changes โ Block PR
```

### 5. Database Backup

```
Schedule (Daily 2 AM) / Manual
  โ
  โโโ Connect to Server
  โ     โ
  โ     โโโ Mysqldump via Docker
  โ     โ     โ
  โ     โ     โโโ Compress (gzip)
  โ     โ     โ     โ
  โ     โ     โ     โโโ Upload to GitHub Artifacts
  โ     โ     โ     โ     โโโ Retention: 30 days
  โ     โ     โ     โ
  โ     โ     โ     โโโ Upload to S3 (optional)
  โ     โ     โ           โโโ Storage Class: Standard-IA
  โ     โ     โ
  โ     โ     โโโ โ Success โ Cleanup temp files
```

---

## ๐ญ Infrastructure

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    GitHub Repository                         โ
โ                  github.com/MuriloM676/leadflow              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  โโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโ  โ
โ  โ  Source Code  โ  โ  GitHub      โ  โ  GitHub         โ  โ
โ  โ  (main)       โ  โ  Actions     โ  โ  Container      โ  โ
โ  โ               โ  โ  Workflows   โ  โ  Registry       โ  โ
โ  โโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโ  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                  Production Server                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                              โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ  Docker Compose Stack                                 โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค  โ
โ  โ                                                        โ  โ
โ  โ  โโโโโโโโโโโโ  โโโโโโโโโโโโ  โโโโโโโโโโ  โโโโโโโโโโ โ  โ
โ  โ  โ  Nginx   โโโโ PHP-FPM  โโโโ MySQL  โ  โ Redis  โ โ  โ
โ  โ  โ  :80     โ  โ app      โ  โ :3306  โ  โ :6379  โ โ  โ
โ  โ  โโโโโโโโโโโโ  โโโโโโโโโโโโ  โโโโโโโโโโ  โโโโโโโโโโ โ  โ
โ  โ                                                        โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                                              โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ  Volumes                                              โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค  โ
โ  โ  โข mysql_data (persistent)                            โ  โ
โ  โ  โข /var/www/leadflow (bind mount)                     โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    External Services                         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  โข AWS S3 (Backups)                                          โ
โ  โข Slack (Notifications)                                     โ
โ  โข Codecov (Coverage Reports)                                โ
โ  โข GitHub Security (Vulnerability Alerts)                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ Security Layers

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Layer 1: Code Analysis                                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  โข PHPStan (Static Analysis)                                 โ
โ  โข Laravel Pint (Code Style)                                 โ
โ  โข CodeQL (Security Patterns)                                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Layer 2: Dependency Scanning                                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  โข Composer Audit (PHP Packages)                             โ
โ  โข Dependency Review (PR Changes)                            โ
โ  โข NPM Audit (Node Packages)                                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Layer 3: Container Scanning                                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  โข Trivy (Docker Image Vulnerabilities)                      โ
โ  โข SARIF Upload (GitHub Security Tab)                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Layer 4: Runtime Protection                                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  โข Environment Secrets (Encrypted)                           โ
โ  โข Required Reviewers (Production)                           โ
โ  โข SSH Key Authentication                                    โ
โ  โข Daily Backups                                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ Monitoring & Observability

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  GitHub Actions Dashboard                                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  โข Workflow Status (Pass/Fail)                               โ
โ  โข Build Times                                               โ
โ  โข Test Coverage Trends                                      โ
โ  โข Security Alerts                                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  GitHub Security Tab                                         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  โข Dependabot Alerts                                         โ
โ  โข CodeQL Findings                                           โ
โ  โข Container Vulnerabilities                                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Slack Notifications                                         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  โข Deploy Success/Failure                                    โ
โ  โข Commit Info                                               โ
โ  โข Author                                                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ Deployment Strategies

### Blue-Green Deployment (Future)
```
โโโโโโโโโโโโโ     โโโโโโโโโโโโโ
โ   Blue    โ     โ   Green   โ
โ (Current) โ     โ   (New)   โ
โโโโโโโฌโโโโโโ     โโโโโโโฌโโโโโโ
      โ                 โ
      โโโโโโโโโโฌโโโโโโโโโ
            Load
          Balancer
```

### Rolling Updates (Current)
```
Old Version โ Drain โ Stop โ New Version โ Start โ Health Check
```

---

## ๐ก Best Practices Implemented

โ **Parallel Testing** - Run tests faster across multiple PHP versions
โ **Caching** - Composer dependencies cached between runs
โ **Multi-stage Builds** - Optimized Docker images
โ **Security Scanning** - Multiple layers of security checks
โ **Automated Backups** - Daily database backups with retention
โ **Health Checks** - Post-deployment verification
โ **Notifications** - Slack integration for deploy status
โ **Environment Protection** - Required approvals for production
โ **Rollback Strategy** - Manual rollback capability
โ **Documentation** - Comprehensive guides and troubleshooting

---

**Architecture Version:** 1.0.0  
**Last Updated:** 2025-10-25  
**Maintained by:** LeadFlow Team
